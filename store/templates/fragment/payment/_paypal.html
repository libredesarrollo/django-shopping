<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}"></script>

<div id="paypalButtons"></div>

<script>
    paypal.Buttons({
        onClick: function() {
            Alpine.store('payment').loading = true;
        },
        onCancel: function (data) {
            Alpine.store('payment').loading = false;
        },
        onError: function (err) {
            Alpine.store('payment').loading = false;
        },
        createOrder: function(data, actions){
            return actions.order.create({
                purchase_units:[
                    {
                        amount: {
                            value:{{ product.price_offert }}
                        }
                    }
                ]
            })
        },
        onApprove: function(data, actions){

            let body = {};

            const csrfToken = '{{ csrf_token }}';

            // const formData = new FormData();
            // Agregar coupon solo si no está vacío
            if ('{{ coupon }}') {
                // formData.append('coupon','{{ coupon }}');
                 body = {
                    coupon: '{{ coupon }}'
                };
            }
 
            // fetch(`/store/payment/${data.orderID}/{{id}}/paypal`, {
            fetch(`{{payment_url_paypal}}`.replace('orderID', data.orderID), {
                method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(body),
                    // body: formData,
                })
                .then(response => response.json())
                .then(response => {
                    // window.location.href = response.data.redirect;
                    window.location.href = response.redirect;
                    // Redirect to success page or show success message
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    }).render("#paypalButtons");
</script>
